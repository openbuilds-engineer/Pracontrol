'use strict'

var fs = require('fs')
var path = require('path')
var ncp = null // lazy load

var style = `
:host {
  
}
::content textarea { height: 15rem; }
::content li { margin-bottom: 1rem; }
`

module.exports = class Module extends WebComponentAbstract {
  initCallback() {
    this.renderCss(style)
    
    if(!this.ser.conf) this.ser.conf = ''
    
    this.userModulesDir = path.join(require('remote').app.getPath('userData'), 'node_modules')
    
    var div = this.newElem('div', true, { className: 'column-system' })
    var left = div.newElem('div')
    var right = div.newElem('div')
    
    var p = left.newElem('p')
    p.newText('Each line of module list represents a module name.')
    p.newElem('br')
    p.newText('Be careful load only trusted modules.')
    
    this.textarea = left.newElem('p').newElem('textarea', true, { value: this.ser.conf, placeholder: 'Module names' })
    this.textarea.on('input', e => this.ser.conf = this.textarea.value)
    left.newElem('p').innerHTML = `<a onclick="location.reload()" class="button">Reload to take effect</a>`
    
    this.loadUserModulesDir().then(res => {
      this.loadModules()
      
      var exampleFile = moduleAvailable('Example')
      right.newElem('h1').textContent = 'Modules development'
      right.newElem('div').innerHTML = `
<ol>
  <li><a onclick="require('electron').shell.showItemInFolder(${JSON.stringify(exampleFile).replace(/"/g, '&quot;')})" title="${exampleFile}" class="button">Take Example.js</a></li>
  <li>Put some code in it</li>
  <li><a onclick="AppEvent('newModule', 'Example')" class="button">Add it to the module list</a></li>
  <li><a onclick="location.reload()" class="button">Reload app</a></li>
  <li><a onclick="require('remote').getCurrentWindow().toggleDevTools()" class="button">Toogle developer tools for debug</a></li>
  <li><a href="${App.package.repository.url}" class="button">Make a pull request</a></li>
  <li>Spread the word!</li>
</ol>
      `
    })
    
    var p = this.newElem('p', true, { textContent: 'Open your require path: ' + this.userModulesDir })
    p.on('click', e => require('electron').shell.showItemInFolder(this.userModulesDir))
    p.style.cursor = 'pointer'
    
    defineAppEvent('newModule', 'Adds new module to module list', 'Modules', "''")
    self.on('newModule', e => {
      this.textarea.value = e.d + '\n'
      this.textarea.dispatchEvent(new Event('input'))
    })
  }
  
  loadUserModulesDir() {
    module.paths.unshift(this.userModulesDir)
    
    return new Promise(resolve => {
      fs.stat(this.userModulesDir, e => {
        if(!e) return resolve()
          
        fs.mkdir(this.userModulesDir, e => {
          if(e) throw e
          ncp = ncp || require('ncp')
          ncp(__dirname + '/Example', this.userModulesDir + '/Example', e => { if(e) throw e; resolve() })
        })
      })
    })
  }
  
  loadModules() {
    this.ser.conf.split('\n').forEach(s =>
      s && moduleAvailable(s) && setImmediate(() => App.newElem(require(s), false) ))
  }
  
  readyCallback() {
    AppEvent('newTab', { elem: this, name: 'Modules', priority: 850 })
  }
}

var moduleAvailable = m => { try { return require.resolve(m) } catch(e) { return false } }
