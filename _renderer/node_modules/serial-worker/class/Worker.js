'use strict'

var SerialPort = require('serialport')

var port = null

process.on('message', e => {
  switch (e.func) {
    case 'SerialPort':
      e.arg[1].parser = SerialPort.parsers.readline('\n')
      port = new SerialPort.SerialPort(e.arg[0], e.arg[1], e.arg[2], callbackFunc('SerialPortCallback'))
      port.emit = (type, arg) => process.send({ type, arg })
      break
      
    case 'list':
      SerialPort.list(callbackFunc('listCallback'))
      break
      
    case 'write':
      port.write(e.arg[0], callbackFunc('writeCallback'))
      break
      
    default:
      (port[e.func])(callbackFunc(e.func + 'Callback'))
      break
  }
})

var callbackFunc = name => {
  return function() {
    var arg = []
    
    Object.keys(arguments).forEach(k => {
      var val = arguments[k]
      if(typeof val == 'object' && val && val.constructor == Error) val = { name: val.name, message: val.message }
      arg.push(val)
    })
    
    process.send({ type: name, arg: arg })
  }
}
